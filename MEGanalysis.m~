% MEGanalysis.m
%
%      usage: MEGanalysis
%         by: laura
%       date: 21/05/15
%    purpose: this master program is used to run all sub-analysis program
%             for the MEG analysis

%% Add the path for fieldtrip and eeglab if necessary
addpath(genpath('/users2/purpadmin/Laura/MRI/GitRepo/fieldtrip'));
addpath(genpath('/users2/purpadmin/Laura/MRI/GitRepo/eeglab13_4_4b'));

%% Run the pre-processing of the data

ld_runMEGPreproc

%% Manual Inspection through Fieldtrip

exptDir = '/Volumes/DRIVE1/DATA/laura/MEG/Pilot';
obs = 'id';
attCond = 'exo';
fileBase = 'R0947_STB_4.28.15_ebi';
sessionDir = [obs '/meg/' attCond '/' fileBase];

dataDir = sprintf('%s/%s', exptDir, sessionDir);
preprocDir = sprintf('%s/preproc', dataDir);

%%% segment the file in half
runFiles = dir(sprintf('%s/%s*.sqd', preprocDir, fileBase));
if isempty(runFiles)
    %% segment original sqd into runs
    dataFile = sprintf('%s/%s.sqd', dataDir, fileBase);
    
    % check settings in ld_segmentSqd before running!
    nRuns = ld_segmentSqd(dataFile);
    runs = 1:2;
    
    %% move run files into preproc directory
    runFiles = dir(sprintf('%s/*half*.sqd', dataDir));
    for iRun = 1:nRuns
        movefile(sprintf('%s/%s', dataDir, runFiles(iRun).name), preprocDir)
    end
else
    % we have done preprocessing before, so find the number of runs
    runTag = getTag(runFiles(end).name,'run');
    nRuns = str2num(runTag(3:4));
    runs = 1:nRuns
end

ld_manualInspection